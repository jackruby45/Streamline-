
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pipeline Heat Transfer Calculator</title>
  <link rel="stylesheet" href="index.css" />
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå°Ô∏è</text></svg>">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.164.1/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.164.1/examples/jsm/",
    "three/": "https://esm.sh/three@^0.179.1/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
  <main>
    <div class="container">
      <h1>Multi-Pipeline Heat Transfer Calculator</h1>
      <p class="subtitle">Calculate steady-state temperatures for complex buried pipeline configurations.</p>
      <p class="developer-credit">Developed by John Sigler</p>
      
      <div class="tabs">
        <button class="tab-link active" data-tab="calculator">Calculator</button>
        <button class="tab-link" data-tab="materials">Material Library</button>
        <button class="tab-link" data-tab="procedure">Procedure &amp; Theory</button>
      </div>

      <div id="calculator" class="tab-content active">
        <div id="calculator-container">
          <fieldset>
              <legend>Project Information</legend>
              <div class="form-grid project-info-grid">
                  <div class="form-group">
                      <label for="project-name">Project Name</label>
                      <textarea id="project-name" name="project-name" rows="1" placeholder="e.g., Downtown Expansion"></textarea>
                  </div>
                  <div class="form-group">
                      <label for="project-location">Location</label>
                      <textarea id="project-location" name="project-location" rows="1" placeholder="e.g., Springfield, USA"></textarea>
                  </div>
                  <div class="form-group">
                      <label for="system-number">System Number</label>
                      <textarea id="system-number" name="system-number" rows="1" placeholder="e.g., SYS-12345"></textarea>
                  </div>
                  <div class="form-group">
                      <label for="engineer-name">Engineer's Name</label>
                      <textarea id="engineer-name" name="engineer-name" rows="1" placeholder="e.g., J. Doe"></textarea>
                  </div>
                  <div class="form-group">
                      <label for="eval-date">Date of Evaluation</label>
                      <input type="date" id="eval-date" name="eval-date">
                  </div>
                  <div class="form-group">
                      <label for="revision-number">Revision Number</label>
                      <input type="number" id="revision-number" name="revision-number" value="1" min="0">
                  </div>
              </div>
              <div class="form-group">
                  <label for="project-description">Project Description</label>
                  <textarea id="project-description" name="project-description" rows="3" placeholder="Briefly describe the project or calculation purpose."></textarea>
              </div>
          </fieldset>
          
          <fieldset>
            <legend>1. Environment</legend>
             <div class="form-group">
                <label for="soil-temp">Ambient Soil Temperature (¬∞F)</label>
                <input type="number" id="soil-temp" name="soil-temp" value="63" required>
              </div>
            <div class="sub-fieldset">
                <h3 class="sub-legend">Soil Layers (from ground surface down)</h3>
                <div id="soil-layers-list">
                    <!-- Soil layers will be dynamically added here -->
                </div>
                <button type="button" id="add-soil-layer-btn" class="add-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                    Add Soil Layer
                </button>
            </div>
          </fieldset>
  
          <fieldset>
            <legend>2. Pipelines</legend>
            <div id="pipe-list">
                <!-- Pipes will be dynamically added here -->
            </div>
            <button type="button" id="add-pipe-btn" class="add-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                Add Pipe
            </button>
          </fieldset>
  
          <div class="main-button-group">
            <button type="button" id="example-btn" class="action-button">Load Example</button>
            <button type="button" id="calculate-btn">Calculate Temperatures</button>
          </div>
        </div>
        
        <div id="output-wrapper" style="display: none;">
          <div id="result-container" role="status" aria-live="polite">
            <h2 class="results-title">Calculation Results</h2>
            <div id="results-table-container">
                <!-- Results table will be injected here -->
            </div>
             <div id="results-error-container" class="result-container error" style="display: none;">
                <!-- Error messages will be displayed here -->
             </div>
          </div>
  
          <div class="button-group">
             <button id="save-scenario-btn" class="action-button" title="Save all current inputs to a file">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1-1H7.5a1 1 0 0 0-1 1H2zm3 4a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 5 5zm2 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 7 5zm2 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 9 5zm2 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 11 5z"/>
                </svg>
                <span>Save Scenario</span>
            </button>
             <button id="load-scenario-btn" class="action-button" title="Load inputs from a scenario file">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1 3.5A1.5 1.5 0 0 1 2.5 2h2.764c.958 0 1.76.743 1.874 1.688l.54 3.622h6.07A1.5 1.5 0 0 1 15 8.5v1.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 10V3.5zM2 6h12v2.5a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5V6zM.5 10a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-1.5a.5.5 0 0 0-.5-.5h-11a.5.5 0 0 0-.5.5V10zM12 4.5a.5.5 0 0 0-.5-.5h-10a.5.5 0 0 0-.5.5v1h11v-1z"/>
                </svg>
                <span>Load Scenario</span>
            </button>
            <input type="file" id="load-scenario-input" accept=".json" style="display:none;" />
            <button id="copy-latex-btn" class="action-button" title="Copy LaTeX report to clipboard">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5-.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/>
              </svg>
              <span id="copy-btn-text">Copy LaTeX Report</span>
            </button>
          </div>
          
          <div id="visualization-options" style="display: none;">
            <div class="view-switcher">
                <input type="radio" id="view-2d" name="view-mode" value="2d" checked>
                <label for="view-2d">2D View</label>
                <input type="radio" id="view-3d" name="view-mode" value="3d">
                <label for="view-3d">3D View</label>
            </div>
            <div id="vis-toggles">
                <label class="vis-toggle-label" for="toggle-flux-vectors">
                    <input type="checkbox" id="toggle-flux-vectors">
                    <span>Show Heat Flux Vectors</span>
                </label>
            </div>
            <div id="isotherm-controls">
                <label class="isotherm-title">2D Isotherm Contours</label>
                <div id="isotherm-list">
                    <!-- Isotherm rows will be added here -->
                </div>
                <button id="add-isotherm-btn" class="add-btn-small">+</button>
            </div>
            <div id="isosurface-controls">
                <label class="isotherm-title">3D Isosurface Contours</label>
                <div id="isosurface-list">
                    <!-- Isosurface rows will be added here -->
                </div>
                <button id="add-isosurface-btn" class="add-btn-small">+</button>
            </div>
          </div>

          <div id="canvas-wrapper">
              <canvas id="heat-transfer-canvas" width="800" height="400"></canvas>
              <canvas id="webgl-canvas" width="800" height="400" style="display: none;"></canvas>
              <div id="tooltip" class="canvas-tooltip"></div>
          </div>
        </div>
      </div>
      
      <div id="materials" class="tab-content">
        <div class="material-library-container">
          <h2>Custom Material Library</h2>
          <p>Define custom materials to use in your calculations. They will be saved in your browser and available for future sessions.</p>

          <div class="material-category">
            <h3>Soils</h3>
            <div class="material-table-container">
                <table id="soil-material-table">
                    <thead><tr><th>Name</th><th>Thermal Conductivity (BTU/hr-ft-¬∞F)</th><th>Actions</th></tr></thead>
                    <tbody><!-- Custom soil materials --></tbody>
                </table>
            </div>
            <form id="add-soil-material-form" class="material-form"><input type="text" placeholder="Material Name" required><input type="number" step="any" placeholder="k-value" required><button type="submit">Add Soil</button></form>
          </div>
          
          <div class="material-category">
            <h3>Pipes</h3>
            <div class="material-table-container">
                <table id="pipe-material-table">
                    <thead><tr><th>Name</th><th>Thermal Conductivity (BTU/hr-ft-¬∞F)</th><th>Actions</th></tr></thead>
                    <tbody><!-- Custom pipe materials --></tbody>
                </table>
            </div>
            <form id="add-pipe-material-form" class="material-form"><input type="text" placeholder="Material Name" required><input type="number" step="any" placeholder="k-value" required><button type="submit">Add Pipe Material</button></form>
          </div>

          <div class="material-category">
            <h3>Insulation</h3>
            <div class="material-table-container">
                <table id="insulation-material-table">
                    <thead><tr><th>Name</th><th>Thermal Conductivity (BTU/hr-ft-¬∞F)</th><th>Actions</th></tr></thead>
                    <tbody><!-- Custom insulation materials --></tbody>
                </table>
            </div>
            <form id="add-insulation-material-form" class="material-form"><input type="text" placeholder="Material Name" required><input type="number" step="any" placeholder="k-value" required><button type="submit">Add Insulation</button></form>
          </div>
          
          <div class="material-category">
            <h3>Bedding</h3>
            <div class="material-table-container">
                <table id="bedding-material-table">
                    <thead><tr><th>Name</th><th>Thermal Conductivity (BTU/hr-ft-¬∞F)</th><th>Actions</th></tr></thead>
                    <tbody><!-- Custom bedding materials --></tbody>
                </table>
            </div>
            <form id="add-bedding-material-form" class="material-form"><input type="text" placeholder="Material Name" required><input type="number" step="any" placeholder="k-value" required><button type="submit">Add Bedding</button></form>
          </div>

        </div>
      </div>

      <div id="procedure" class="tab-content">
        <div class="prose">
          <h2>Step-by-Step Guide</h2>
          <ol>
              <li>
                  <strong>Manage Materials (Optional):</strong>
                  <p>In the "Material Library" tab, you can pre-define custom materials for soil, pipes, insulation, etc. These will be saved in your browser and appear in the dropdown lists in the calculator.</p>
              </li>
              <li>
                  <strong>Define the Environment:</strong>
                  <p>Set the global <strong>Ambient Soil Temperature</strong>. Then, in the "Soil Layers" section, define the ground composition from the surface downwards. Click <strong>Add Soil Layer</strong> to create strata. For each layer, specify its material (thermal conductivity) and its thickness.</p>
              </li>
              <li>
                  <strong>Add and Configure Pipelines:</strong>
                  <p>Click <strong>Add Pipe</strong> to add pipelines to your scenario. For each pipe, you must define:</p>
                  <ul>
                      <li><strong>Role:</strong> Is it a 'Heat Source' with a known temperature, or an 'Affected Pipe' whose temperature you want to find?</li>
                      <li><strong>Orientation:</strong> Is it 'Parallel' (running into the screen) or 'Perpendicular' (running across the screen)?</li>
                      <li><strong>Coordinates:</strong> Define its position. Parallel pipes use X (horizontal) and Z (depth). Perpendicular pipes use Y (distance into the screen) and Z (depth).</li>
                      <li><strong>Temperature:</strong> Must be set for 'Heat Source' pipes.</li>
                      <li><strong>Physical Properties:</strong> Use presets or custom values for pipe diameter, wall thickness, insulation, and bedding. The tool will provide real-time feedback if a pipe's depth is not sufficient for its size.</li>
                  </ul>
              </li>
              <li>
                  <strong>Calculate and Review Results:</strong>
                  <p>Click the "Calculate Temperatures" button. The tool will display a table showing the calculated final temperature for each 'Affected Pipe'. An interactive diagram will visualize the complete configuration. Use the view switcher to toggle between a 2D cross-section and a fully interactive 3D model. In the 2D view, you can add multiple, color-coded isotherm contours to trace specific temperature lines. In 3D view, you can add volumetric isosurfaces with adjustable opacity.</p>
              </li>
              <li>
                  <strong>Save, Load, and Report:</strong>
                  <p>After a calculation, you can click <strong>Save Scenario</strong> to download a file of your entire configuration. Use <strong>Load Scenario</strong> to restore a complex setup. You can click <strong>Copy LaTeX Report</strong> to generate a full, formatted report for any LaTeX editor (like Overleaf).</p>
              </li>
          </ol>

          <h2>Theoretical Background</h2>
          <p>This tool analyzes steady-state conductive heat transfer between multiple buried pipelines within a stratified soil environment. The methodology uses the <strong>principle of superposition</strong> combined with a thermal resistance network model.</p>
          <h3>Core Calculation</h3>
          <p>The calculation is performed using a consistent set of internal base units (SI: meters, Kelvin, Watts). All user inputs are converted to this base system before calculation, and all outputs are converted back to the user's selected display system (Imperial).</p>
          <p>The temperature rise (`&Delta;T`) at any point due to a line heat source `Q` (in W/m) is given by:</p>
          <code>&Delta;T = (Q / (2 * &pi; * k_eff)) * ln(d_image / d_real)</code>
          <ul>
            <li>`k_eff`: The effective thermal conductivity of the medium between the source and the point of interest (in W/m-K).</li>
            <li>`d_real`: The physical distance from the source to the point.</li>
            <li>`d_image`: The distance from the "image" source (mirrored across the ground plane) to the point. This term accounts for the adiabatic (no heat flow) boundary condition at the ground surface.</li>
          </ul>
          <p>The heat flux `Q` from a source pipe is determined by its total thermal resistance to the ambient soil. The final temperature of any "affected" pipe is the sum of the ambient soil temperature and the temperature rises caused by every heat source in the system (superposition).</p>
        </div>
      </div>
    </div>
  </main>

  <!-- TEMPLATES FOR DYNAMIC UI -->
  <div id="templates" style="display: none;">
      <!-- Soil Layer Template -->
      <div class="soil-layer-row">
          <div class="form-group">
              <label>Layer Material</label>
              <select class="soil-layer-material-select"></select>
          </div>
          <div class="form-group">
              <label>Layer Thickness (ft)</label>
              <input type="number" class="soil-layer-thickness" value="5" min="0.1" step="0.1" required>
          </div>
          <button type="button" class="remove-btn" title="Remove Layer">&times;</button>
      </div>

      <!-- Pipe Template -->
      <div class="pipe-row">
          <button type="button" class="remove-btn" title="Remove Pipe">&times;</button>
          <div class="form-group pipe-name-group">
            <label>Pipe ID</label>
            <input type="text" class="pipe-name" value="Pipe 1">
          </div>
          <div class="form-group">
            <label>Pipe Role</label>
            <select class="pipe-role">
                <option value="heat_source">Heat Source</option>
                <option value="affected_pipe" selected>Affected Pipe</option>
            </select>
          </div>
          <div class="form-group">
              <label>Orientation</label>
              <select class="pipe-orientation">
                  <option value="parallel" selected>Parallel (into screen)</option>
                  <option value="perpendicular">Perpendicular (across screen)</option>
              </select>
          </div>
          <div class="coord-group x-coord-group">
            <div class="form-group">
              <label>X-Coordinate (ft)</label>
              <input type="number" class="pipe-x" value="0" step="0.1">
            </div>
          </div>
          <div class="coord-group y-coord-group hidden">
            <div class="form-group">
              <label>Y-Coordinate (ft)</label>
              <input type="number" class="pipe-y" value="0" step="0.1">
            </div>
          </div>
          <div class="form-group">
            <label>Z-Coordinate (Depth, ft)</label>
            <input type="number" class="pipe-z" value="4" min="0" step="0.1">
          </div>
          <div class="form-group">
            <label>Temperature (¬∞F)</label>
            <input type="number" class="pipe-temp" value="450" disabled>
          </div>
          <div class="form-group">
            <label>Pipe Size (Sch. 40)</label>
            <select class="pipe-preset"></select>
          </div>
          <div class="form-group">
            <label>Pipe OD (in)</label>
            <input type="number" class="pipe-od" min="0" step="0.001">
          </div>
          <div class="form-group">
            <label>Wall Thk. (in)</label>
            <input type="number" class="pipe-thickness" min="0" step="0.001">
          </div>
           <div class="form-group">
            <label>Pipe Material</label>
            <select class="pipe-material-select"></select>
          </div>
          <div class="form-group">
            <label>Insulation Thk. (in)</label>
            <input type="number" class="pipe-insulation-thickness" value="0" min="0" step="0.1">
          </div>
          <div class="form-group">
            <label>Insulation Material</label>
            <select class="pipe-insulation-material-select"></select>
          </div>
          <div class="form-group">
            <label>Bedding Thk. (in)</label>
            <input type="number" class="pipe-bedding-thickness" value="0" min="0" step="0.1">
          </div>
           <div class="form-group">
            <label>Bedding Material</label>
            <select class="pipe-bedding-material-select"></select>
          </div>
          <div class="pipe-error-container"></div>
      </div>

      <!-- Isotherm Template -->
      <div class="isotherm-row">
          <input type="checkbox" class="toggle-isotherm-row" checked>
          <input type="number" class="isotherm-temp-input">
          <label class="isotherm-unit-label">¬∞F</label>
          <input type="color" class="isotherm-color-input" value="#FFFFFF">
          <button type="button" class="remove-btn remove-isotherm-btn">&times;</button>
      </div>

      <!-- Isosurface Template -->
      <div class="isosurface-row">
          <input type="checkbox" class="toggle-isosurface-row" checked>
          <input type="number" class="isosurface-temp-input">
          <label class="isotherm-unit-label">¬∞F</label>
          <input type="color" class="isosurface-color-input" value="#48BFE3">
          <div class="opacity-slider-group">
              <label>Opacity</label>
              <input type="range" class="isosurface-opacity-slider" min="0" max="1" step="0.05" value="0.3">
          </div>
          <button type="button" class="remove-btn remove-isosurface-btn">&times;</button>
      </div>

  </div>

  <script>
      if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
              navigator.serviceWorker.register('/sw.js').then(registration => {
                  console.log('ServiceWorker registration successful with scope: ', registration.scope);
              }, err => {
                  console.log('ServiceWorker registration failed: ', err);
              });
          });
      }
  </script>
  <script type="module" src="index.tsx"></script>
<script type="module" src="/index.tsx"></script>
</body>
</html>